<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">

<chapter id="Puppet_Conf">
<title>Puppet configuration</title>

<para>
TODO (short introduction)
</para>

<section id="CREAM_basic">
<title>CREAM service parameters</title>
<para>
These are the basic configuration parameters related to the CREAM service:
<itemizedlist>
    <listitem><para><literal>creamce::batch_system</literal> (string): The installed batch system,
    <emphasis>mandatory</emphasis>, one of "pbs", "slurm", "condor", "lsf"</para></listitem>
    <listitem><para><literal>creamce::host</literal> (string): The fully qualified Computing Element
    host name, default the host name</para></listitem>
    <listitem><para><literal>creamce::port</literal> (integer): The tomcat listen port, default 8443</para></listitem>
    <listitem><para><literal>creamce::site::name</literal> (string): The human-readable name of the site,
    default the host name</para></listitem>
    <listitem><para><literal>creamce::site::email</literal> (string): The main email contact for the site.
    The syntax is a coma separated list of email addresses, default undefined</para></listitem>
    <listitem><para><literal>creamce::sandbox_path</literal> (string): The directory where the sandbox files are staged
    on the CREAM CE node, default "/var/cream_sandbox"</para></listitem>
    <listitem><para><literal>creamce::delegation::purge_rate</literal> (integer): Specifies in minutes how often the
    delegation purger has to run, default 10 minutes</para></listitem>
    <listitem><para><literal>creamce::lease::time</literal> (integer): The maximum allowed lease time in second. If a
    client specifies a lease time too big, this value is used instead, default 36000 seconds.</para></listitem>
    <listitem><para><literal>creamce::lease::rate</literal> (integer): Specifies in minutes how often the job purger
    has to run, default 30 minutes</para></listitem>
</itemizedlist>
</para>
<para>
The following parameters enable and configure the internal monitoring system. Whenever a resource metric exceeds
the related resource limit the CREAM CE suspends the job submission.
<itemizedlist>
    <listitem><para><literal>creamce::enable_limiter</literal> (boolean): In order to disable the limiter,
    it is needed to set this parameter value to false and restart the service, default true</para></listitem>
    <listitem><para><literal>creamce::limit::load1</literal> (integer): Limiter threshold for the load average
    (1 minute), default 40</para></listitem>
    <listitem><para><literal>creamce::limit::load5</literal> (integer): Limiter threshold for the load average
    (5 minute), default 40</para></listitem>
    <listitem><para><literal>creamce::limit::load15</literal> (integer): Limiter threshold for the load average
    (15 minute), default 20</para></listitem>
    <listitem><para><literal>creamce::limit::memusage</literal> (integer): Limiter threshold for the memory usage,
    default 95 (percentage)</para></listitem>
    <listitem><para><literal>creamce::limit::swapusage</literal> (integer): Limiter threshold for the swap usage,
    default 95 (percentage)</para></listitem>
    <listitem><para><literal>creamce::limit::fdnum</literal> (integer): Limiter threshold for the number of file
    descriptors, default 500</para></listitem>
    <listitem><para><literal>creamce::limit::diskusage</literal> (integer): Limiter threshold for the disk usage,
    default 95 (percentage)</para></listitem>
    <listitem><para><literal>creamce::limit::ftpconn</literal> (integer): Limiter threshold for the number of
    concurrent ftp connections, default 30</para></listitem>
    <listitem><para><literal>creamce::limit::fdtomcat</literal> (integer): Limiter threshold for the number of
    file descriptors, default 800</para></listitem>
    <listitem><para><literal>creamce::limit::activejobs</literal> (integer): Limiter threshold for the number of
    active jobs, default -1 (unlimited)</para></listitem>
    <listitem><para><literal>creamce::limit::pendjobs</literal> (integer): Limiter threshold for the number of
    pending jobs, default -1 (unlimited)</para></listitem>
</itemizedlist>
</para>
<para>
The following parameters configure the internal job purger mechanism, all the values are expressed in number of days
<itemizedlist>
    <listitem><para><literal>creamce::job::purge_rate</literal> (integer): Specifies in minutes how often the job
    purger has to run, default 300 minutes.</para></listitem>
    <listitem><para><literal>creamce::purge::aborted</literal> (integer): Specifies how often the job purger deletes
    the aborted jobs, default 10 days</para></listitem>
    <listitem><para><literal>creamce::purge::cancel</literal> (integer): Specifies how often the job purger deletes the
    cancelled jobs, default 10 days</para></listitem>
    <listitem><para><literal>creamce::purge::done</literal> (integer): Specifies how often the job purger deletes the
    executed jobs, default 10 days</para></listitem>
    <listitem><para><literal>creamce::purge::failed</literal> (integer): Specifies how often the job purger deletes the
    failed jobs, default 10 days</para></listitem>
    <listitem><para><literal>creamce::purge::register</literal> (integer): Specifies how often the job purger deletes
    the registered jobs, default 2 days</para></listitem>
</itemizedlist>
</para>
<para>
The following parameters configure the job wrapper:
<itemizedlist>
    <listitem><para><literal>creamce::jw::proxy_retry_wait</literal> (integer): The minimum time interval expressed in
    seconds, between the first attempt and the second one for retrieving the user delegation proxy,
    default 60</para></listitem>
    <listitem><para><literal>creamce::jw::isb::retry_count</literal> (integer): The maximum number of ISB file transfers
    that should be tried, default 2</para></listitem>
    <listitem><para><literal>creamce::jw::isb::retry_wait</literal> (integer): If during a input sandbox file transfer
    occurs a failure, the JW retries the operation after a while. The sleep time between the first attempt and the
    second one is the “initial wait time” (i.e. the wait time between the first attempt and the second one) expressed
    in seconds. In every next attempt the sleep time is doubled. Default 60 seconds.</para></listitem>
    <listitem><para><literal>creamce::jw::osb::retry_count</literal> (integer): The maximum number of ISB file transfers
    that should be tried, default 2</para></listitem>
    <listitem><para><literal>creamce::jw::osb::retry_wait</literal> (integer): If during a output sandbox file transfer
    occurs a failure, the JW retries the operation after a while. The sleep time between the first attempt and the
    second one is the “initial wait time” (i.e. the wait time between the first attempt and the second one) expressed
    in seconds. In every next attempt the sleep time is doubled. Default 300 seconds.</para></listitem>
</itemizedlist>

<screen>
* **creamce::quality_level** (_string_): The service level of the Computing Element, default "production"
* **creamce::environment** (_hash_): The environment variables passed to the CE, default empty hash
* **creamce::gridenvfile::sh** (_string_): The path of the environment definitions (standard shell), default "/etc/profile.d/grid-env.sh"
* **creamce::gridenvfile::csh** (_string_): The path of the environment definitions (korn shell), default "/etc/profile.d/grid-env.csh"
* **creamce::cga::logfile** (_string_): The path of the log file for grid account cleaner, default "/var/log/cleanup-grid-accounts.log"
* **creamce::cga::cron_sched** (_string_): The time parameters for the grid account cleaner cron script, default "30 1 * * *"
* **creamce::at_deny_extras** (_list_): Extra items to be inserted into the ban list for the command at, default empty list
* **creamce::cron_deny_extras** (_list_): Extra items to be inserted into the ban list for cron, default empty list
* **creamce::sudo_logfile** (_string_): The path of the log file for sudo, default empty string (log on syslog)
* **creamce::default_pool_size** (_integer_): The default number of users in a pool account, used if **pool_size** is not define for a VO group, default 100
</screen>


</para>
</section><!-- end of CREAM_basic -->



<section id="BLAH_config">
<title>BLAH</title>
<para>
These are the basic configuration parameters for BLAH:
<itemizedlist>
    <listitem><para><literal>blah::config_file</literal> (string): The path of the main BLAH configuration file,
    default "/etc/blah.config"</para></listitem>
    <listitem><para><literal>blah::logrotate::interval</literal> (integer): The interval in days for log rotation,
    default 365 days</para></listitem>
    <listitem><para><literal>blah::logrotate::size</literal> (string): The size of a log file in MB,
    default "10M"</para></listitem>
    <listitem><para><literal>blah::use_blparser</literal> (boolean): If true it enables the BLParser service
    otherwise BUpdater/BNotifier is used, default false</para></listitem>
    <listitem><para><literal>creamce::blah_timeout</literal> (integer): Represents the maximum time interval in seconds
    accepted by CREAM for the execution of commands by BLAH, default 300 seconds</para></listitem>
    <listitem><para><literal>creamce::job::prefix</literal> (string): The prefix to be used for the BLAH job id, default
    "cream_"</para></listitem>
</itemizedlist>
</para>
<para>
The following parameters configure BLAH if BNotifier/BUpdater are enabled:
<itemizedlist>
    <listitem><para><literal>blah::bupdater::loop_interval</literal> (integer): The interval in seconds between two
    BUpdater sessions, default 30 seconds.</para></listitem>
    <listitem><para><literal>blah::bupdater::notify_port</literal> (integer): The service port for the BNotifier,
    default 56554</para></listitem>
    <listitem><para><literal>blah::bupdater::logrotate::interval</literal> (integer): The interval in days for log
    rotation, default 50</para></listitem>
    <listitem><para><literal>blah::bupdater::logrotate::size</literal> (string): The size of a log file in MB,
    default "10M"</para></listitem>
</itemizedlist>
</para>
<para>
The following parameters configure BLAH if the BLParser is enabled:
<itemizedlist>
    <listitem><para><literal>blah::blp::host</literal> (string): The host name for the primary BLParser,
    <emphasis>mandatory</emphasis> if BLParser is used, default undefined</para></listitem>
    <listitem><para><literal>blah::blp::port</literal> (integer): The service port for the primary BLParser,
    default 33333</para></listitem>
    <listitem><para><literal>blah::blp::num</literal> (integer): The number of BLParser enabled instances,
    default 1</para></listitem>
    <listitem><para><literal>blah::blp::host1</literal> (string): The host name for the secondary BLParser,
    default undefined</para></listitem>
    <listitem><para><literal>blah::blp::port1</literal> (integer): The service port for the secondary BLParser,
    default 33334</para></listitem>
    <listitem><para><literal>creamce::listener_port</literal> (integer): The port used by CREAM to receive notifications
    about job status changes sent by the BLParser/JobWrapper, default 49152</para></listitem>
    <listitem><para><literal>creamce::blp::retry_delay</literal> (integer): The time interval in seconds between two
    attempts to contact the BLAH parser, default 60 seconds</para></listitem>
    <listitem><para><literal>creamce::blp::retry_count</literal> (integer): Represents the number of attempts to contact
    the BLAH parser (if it is not reachable) before giving up. If -1 is specified, CREAM will never give up ,
    default 100</para></listitem>
</itemizedlist>
</para>
</section><!-- end of BLAH_config -->




<!-- section id="">
<title></title>
<para>
</para>
</section --><!-- end of  -->





<section id="Hiera_example">
<title>Configuration example</title>

<para>
<screen>
---
creamce::mysql::root_password :      mysqlp@$$w0rd
creamce::creamdb::password :         creamp@$$w0rd
creamce::creamdb::minpriv_password : minp@$$w0rd
apel::db::pass :                     apelp@$$w0rd
creamce::batch_system :              pbs
creamce::use_argus :                 false
creamce::default_pool_size :         10
creamce::info::capability :          [ "CloudSupport=false", "Multinode=true" ]

creamce::repo_urls :                 [ 
                                       "http://repository.example.org/dist/CREAM/repos/centos7/cream.repo",
                                       "http://repository.example.org/dist/CREAM/repos/centos7/security_extras.repo"
                                     ]
creamce::rpm_key_urls :              [ "http://repository.example.org/dist/RPM-GPG-KEY-cream-dist" ]

gridftp::params::certificate :       "/etc/grid-security/hostcert.pem"
gridftp::params::key :               "/etc/grid-security/hostkey.pem"
gridftp::params::port :              2811

creamce::queues :
    long :  { groups : [ dteam, dteamprod ] }
    short : { groups : [ dteamsgm ] }

creamce::vo_table :
    dteam : { 
        vo_app_dir : /afs/dteam, 
        vo_default_se : storage.pd.infn.it,
        servers : [
                      {
                          server : voms.hellasgrid.gr,
                          port : 15004,
                          dn : /C=GR/O=HellasGrid/OU=hellasgrid.gr/CN=voms.hellasgrid.gr,
                          ca_dn : "/C=GR/O=HellasGrid/OU=Certification Authorities/CN=HellasGrid CA 2016"
                      },
                      {
                          server : voms2.hellasgrid.gr,
                          port : 15004,
                          dn : /C=GR/O=HellasGrid/OU=hellasgrid.gr/CN=voms2.hellasgrid.gr,
                          ca_dn : "/C=GR/O=HellasGrid/OU=Certification Authorities/CN=HellasGrid CA 2016"
                      }
        ],
        groups : {
            dteam : { fqan : [ "/dteam" ], gid : 9000 },
            
            dteamsgm : { fqan : [ "/dteam/sgm/ROLE=developer" ], gid : 9001, pub_admin : true },
            
            dteamprod : { fqan : [ "/dteam/prod/ROLE=developer" ], gid : 9002 }
        },
        users : {
            dteamusr : { first_uid : 6000, groups : [ dteam ], name_pattern : "%&lt;prefix>s%03%&lt;index>d" },
            
            dteamsgmusr : { first_uid : 6100, groups : [ dteamsgm, dteam ], pool_size : 5, name_pattern : "%&lt;prefix&gt;s%02&lt;index&gt;d" },
            
            dteamprodusr : { first_uid : 6200, groups : [ dteamprod, dteam ], pool_size : 5, name_pattern : "%&lt;prefix&gt;s%02&lt;index&gt;d" }
        }
    }

creamce::hardware_table :
    subcluster001 : {
        ce_cpu_model : XEON,
        ce_cpu_speed : 2500,
        ce_cpu_vendor : Intel,
        ce_cpu_version : 5.1,
        ce_physcpu : 2,
        ce_logcpu : 2,
        ce_minphysmem : 2048,
        ce_minvirtmem : 4096,
        ce_os_family : "linux",
        ce_os_name : "CentOS",
        ce_os_arch : "x86_64",
        ce_os_release : "7.0.1406",
        ce_outboundip : true,
        ce_inboundip : false,
        ce_runtimeenv : [ "tomcat_6_0", "mysql_5_1" ],
        subcluster_tmpdir : /var/tmp/subcluster001,
        subcluster_wntmdir : /var/glite/subcluster001,
        ce_benchmarks : { specfp2000 : 420, specint2000 : 380, hep-spec06 : 780 },
        nodes : [ "node-01.mydomain", "node-02.mydomain", "node-03.mydomain" ]
        # Experimental support to GPUs
        accelerators : {
            acc_device_001 : {
                type : GPU,
                log_acc : 4,
                phys_acc : 2,
                vendor : NVidia,
                model : "Tesla k80",
                version : 4.0,
                clock_speed : 3000,
                memory : 4000 
            }
        }
    }

creamce::software_table :
    tomcat_6_0 : {
        name : "tomcat",
        version : "6.0.24",
        license : "ASL 2.0",
        description : "Tomcat is the servlet container" 
    }
    mysql_5_1 : {
        name : "mysql",
        version : "5.1.73",
        license : "GPLv2 with exceptions",
        description : "MySQL is a multi-user, multi-threaded SQL database server" 
    }

creamce::vo_software_dir : /afs

creamce::se_table :
    storage.pd.infn.it : { mount_dir : "/data/mount", export_dir : "/storage/export", type : Storm, default : true }
    cloud.pd.infn.it : { mount_dir : "/data/mount", export_dir : "/storage/export",  type : Dcache }
</screen>
</para>
</section><!-- end of Hiera_example -->

</chapter>
